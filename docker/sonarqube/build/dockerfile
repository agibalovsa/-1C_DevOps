ARG SONAR_REPO=sonarqube \
    SONAR_VERSION=lts-community

# hadolint ignore=DL3006
FROM "${SONAR_REPO}:${SONAR_VERSION}"

ARG SONAR_VERSION \
    RUSSIAN_PACK_VERSION \
    BSL_PLUGIN_VERSION \
    BRANCH_PLUGIN_VERSION

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

LABEL maintainer="Agibalov Sergei <agibse@rarus.ru>" \
    version="${SONAR_VERSION}" \
    manufacturer="SonarSource SA" \
    libs="Russian pack:${RUSSIAN_PACK_VERSION}, BSL plugin:${BSL_PLUGIN_VERSION}, Branch plugin:${BRANCH_PLUGIN_VERSION}"

USER root

WORKDIR /opt/sonarqube

# hadolint ignore=SC1091
RUN --mount=from=context,target=/context \
    --mount=from=context_arg,target=/context_arg \
    set -eux; \
    . ../../context/post_install; \
    install_plugins

ENV SONAR_WEB_JAVAADDITIONALOPTS="-javaagent:./extensions/plugins/sonarqube-community-branch-plugin-${BRANCH_PLUGIN_VERSION}.jar=web" \
    SONAR_CE_JAVAADDITIONALOPTS="-javaagent:./extensions/plugins/sonarqube-community-branch-plugin-${BRANCH_PLUGIN_VERSION}.jar=ce"

# hadolint ignore=SC1091
RUN --mount=from=context,target=/context \
    --mount=from=common_context,target=/common_context \
    --mount=from=context_arg,target=/context_arg \
    set -eux; \
    . ../../context/post_install; \
    install_cert

USER sonarqube