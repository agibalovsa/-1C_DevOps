ARG REGISTRY= \
    OS_TAG=mcr.microsoft.com/windows/servercore:ltsc2022

# hadolint ignore=DL3006
FROM "${REGISTRY}${OS_TAG}"

ARG MSSQL_VERSION

LABEL maintainer="Agibalov Sergei <agibse@rarus.ru>" \
      version="${MSSQL_VERSION}" \
      manufacturer="Microsoft"

SHELL [ "pwsh", "-Command", "$ErrorActionPreference = 'Stop'; $ProgressPreference = 'Continue'; $verbosePreference='Continue';" ]

COPY [ "build_context/pre_install.ps1", "/build_context/pre_install.ps1" ]

RUN . "/build_context/pre_install.ps1" ; \
    Install-Packs ; \
    Remove-Item "/build_context/pre_install.ps1" ;

COPY [ "build_context/install.ps1", "/build_context/install.ps1" ]

ARG DISTR_URL=https://download.microsoft.com/download/3/8/d/38de7036-2433-4207-8eae-06e247e17b25/ \
    DISTR_NAME=SQLServer2022-x64-ENU \
    # https://sqlserverbuilds.blogspot.com/#sql2022x
    UPD_URL

RUN . "/build_context/install.ps1" ; \
    Install-Packs ${Env:DISTR_URL} ${Env:DISTR_NAME} ;

RUN . "/build_context/install.ps1" ; \
    Install-Update ${Env:UPD_URL} ;

RUN Remove-Item build_context -Recurse ; \
    Move-Item -Path 'C:/Program Files/Microsoft SQL Server/MSSQL16.MSSQLSERVER/MSSQL' -Destination 'C:/Program Files/Microsoft SQL Server/MSSQL16.MSSQLSERVER/MSSQL_temp' ;

COPY [ "entrypoint.ps1", "/entrypoint.d/entrypoint_mssql.ps1" ]
COPY [ "build_context/entrypoint.ps1", "/entrypoint.ps1" ]

HEALTHCHECK CMD powershell -command ./healthcheck.ps1

# Entrypoint param:
# - MSSQL init+password: "mssql=init"
# - MSSQL run:  "mssql=mssql"
ENTRYPOINT [ "pwsh", "/entrypoint.ps1" ]