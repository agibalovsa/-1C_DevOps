#!/usr/bin/env bash

# Installing gosu utils <https://github.com/tianon/gosu>
#
install_gosu () {

    GOSU_VERSION=${GOSU_VERSION:-1.17}
    
    if command -v gosu > /dev/null; then
        exit 0;
    fi;

    dpkgArch="$(dpkg --print-architecture | awk -F- '{ print $NF }')"; \
    wget --progress=dot:giga --timeout=30 -O /usr/local/bin/gosu "https://github.com/tianon/gosu/releases/download/${GOSU_VERSION}/gosu-$dpkgArch"; \
    wget --progress=dot:giga --timeout=30 -O /usr/local/bin/gosu.asc "https://github.com/tianon/gosu/releases/download/${GOSU_VERSION}/gosu-$dpkgArch.asc"; \
    \
# verify the signature
    GNUPGHOME="$(mktemp -d)"; \
    export GNUPGHOME; \
    # hkps://keys.openpgp.org, hkps://keyserver.ubuntu.com
    gpg --batch --keyserver hkps://keyserver.ubuntu.com --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4; \
    gpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu; \
    gpgconf --kill all; \
    rm -rf "${GNUPGHOME}" /usr/local/bin/gosu.asc; \
    \
# verify that the binary works
    chmod +x /usr/local/bin/gosu; \
    gosu --version; \
    gosu nobody true;

}