ARG REGISTRY= \
    OS_TAG=debian:bookworm-slim

# hadolint ignore=DL3006
FROM "${REGISTRY}${OS_TAG}"

ARG PG_MAJOR_VERSION \
    PG_VERSION \
    PG_PATH \
    PG_BIN_PATH \
    PG_SHARE_PATH

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

LABEL maintainer="Agibalov Sergei <agibse@rarus.ru>" \
      version="${PG_VERSION}" \
      manufacturer="Postgres pro" \
      libs="https://github.com/docker-library/postgres/blob/master/Dockerfile-debian.template"

# hadolint ignore=SC1091
RUN --mount=from=common_context,target=/common_context \
    --mount=from=context,target=/context \
    --mount=from=context_arg,target=/context_arg \
    set -eux; \
    . context/pre_install; \
    install_packs; \
    set_users; \
    set_locals; \
    . common_context/gosu; \
    install_gosu

ENV LANG="en_US.utf8" \
    PGMAJOR="${PG_MAJOR_VERSION}" \
    PATH="${PATH}:${PG_BIN_PATH}" \
    PGDATA="${PG_PATH}/data" \
    PGSHARE="${PG_SHARE_PATH}/data"

# hadolint ignore=SC1091
RUN --mount=from=context,target=/context \
    --mount=from=context_arg,target=/context_arg \
    set -eux; \
    . context/install; \
    install_packs

# hadolint ignore=SC1091
RUN --mount=from=context,target=/context \
    --mount=from=context_arg,target=/context_arg \
    set -eux; \
    . context/post_install; \
    set_startup

COPY --chmod=777 [ "docker-entrypoint.sh", "docker-ensure-initdb.sh", "/usr/local/bin/" ]
RUN ln -sT docker-ensure-initdb.sh /usr/local/bin/docker-enforce-initdb.sh

VOLUME [ "${PG_PATH}/data" ]
EXPOSE 5432
STOPSIGNAL SIGINT

ENTRYPOINT ["docker-entrypoint.sh"]

CMD ["postgres"]