#!/usr/bin/env bash

set_startup() {

    # shellcheck source=/dev/null
    . /context_arg/.arg;

    install --verbose --directory --owner postgres --group postgres --mode 3777 /var/run/postgresql;

# this 1777 will be replaced by 0700 at runtime (allows semi-arbitrary "--user" values)
    install --verbose --directory --owner postgres --group postgres --mode 1777 "${PG_PATH}/data"

# make the sample config easier to munge (and "correct by default")
    dpkg-divert --add --rename --divert "${PG_SHARE_PATH}/../postgresql.conf.sample.dpkg" "${PG_SHARE_PATH}/postgresql.conf.sample";
    cp -v "${PG_SHARE_PATH}/../postgresql.conf.sample.dpkg" "${PG_SHARE_PATH}/../postgresql.conf.sample";
    ln -sv ../postgresql.conf.sample "${PG_SHARE_PATH}";
    sed -ri "s!^#?(listen_addresses)\s*=\s*\S+.*!\1 = '*'!" "${PG_SHARE_PATH}/../postgresql.conf.sample";
    grep -F "listen_addresses = '*'" "${PG_SHARE_PATH}/../postgresql.conf.sample";

    postgres --version

}